<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Chat IA Retroworld</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background:#0b1020; color:#f5f5f5; font-family:system-ui, -apple-system, "Segoe UI", sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
    .chat-card { width:100%; max-width:420px; background:#121729; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,0.4); display:flex; flex-direction:column; overflow:hidden; border:1px solid rgba(255,255,255,0.05); }
    .chat-header { padding:12px 16px; background:linear-gradient(135deg,#ff0066,#ffcc00); color:#121212; font-weight:700; font-size:15px; display:flex; align-items:center; gap:8px; }
    .chat-header span.badge { font-size:11px; padding:2px 8px; border-radius:999px; background:rgba(0,0,0,0.12); }
    .chat-messages { padding:12px; flex:1; overflow-y:auto; }
    .msg { margin-bottom:10px; font-size:13px; line-height:1.4; max-width:90%; }
    .msg-user { margin-left:auto; text-align:right; }
    .bubble { display:inline-block; padding:8px 10px; border-radius:12px; white-space:pre-wrap }
    .bubble-user { background:#2e5bff; color:white; border-bottom-right-radius:2px; }
    .bubble-bot { background:#1b2235; border-bottom-left-radius:2px; }
    .msg-meta { font-size:10px; opacity:0.6; margin-top:2px; }
    .chat-input { border-top:1px solid rgba(255,255,255,0.06); padding:8px; display:flex; gap:6px; background:#101526; }
    .chat-input textarea { flex:1; resize:none; border-radius:10px; border:1px solid rgba(255,255,255,0.08); padding:8px 10px; font-size:13px; font-family:inherit; background:#0c1020; color:#f5f5f5; min-height:40px; max-height:80px; outline:none; }
    .chat-input button { border:none; border-radius:999px; padding:0 14px; font-size:13px; font-weight:600; cursor:pointer; background:#ff0066; color:white; display:flex; align-items:center; gap:4px; white-space:nowrap; }
    .chat-input button:disabled { opacity:0.5; cursor:default; }
    .typing { font-size:11px; opacity:0.7; padding:0 12px 6px; }
  </style>
</head>
<body>
  <div class="chat-card">
    <div class="chat-header">
      ðŸ¤– IA Retroworld
      <span class="badge">BÃªta</span>
    </div>
    <div id="messages" class="chat-messages"></div>
    <div id="typing" class="typing" style="display:none;">L'IA rÃ©dige une rÃ©ponseâ€¦</div>
    <form id="chat-form" class="chat-input">
      <textarea id="input" placeholder="Posez votre question (tarifs, goÃ»ter, VR, fidÃ©litÃ©...)"></textarea>
      <button type="submit" id="send-btn">Envoyer</button>
    </form>
  </div>

  <script>
    const API_URL = "/chat/retroworld";
    const messagesEl = document.getElementById("messages");
    const typingEl = document.getElementById("typing");
    const inputEl = document.getElementById("input");
    const formEl = document.getElementById("chat-form");
    const sendBtn = document.getElementById("send-btn");

    function getOrCreateUserId(){
      const key = "rw_user_id";
      let v = "";
      try { v = localStorage.getItem(key) || ""; } catch(e) {}
      if(!v){
        v = "u_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
        try { localStorage.setItem(key, v); } catch(e) {}
      }
      return v;
    }
    const USER_ID = getOrCreateUserId();

    let MEM_CONV_ID = "";

    function getConvId(){
      if (MEM_CONV_ID) return MEM_CONV_ID;
      try {
        const v = localStorage.getItem("rw_conversation_id") || "";
        if(v) { MEM_CONV_ID = v; return v; }
      } catch(e) {}
      return "";
    }
    function setConvId(v){
      if(!v) return;
      MEM_CONV_ID = v;
      try { localStorage.setItem("rw_conversation_id", v); } catch(e) {}
    }

    function addMessage(text, from = "bot") {
      const wrap = document.createElement("div");
      wrap.className = "msg " + (from === "user" ? "msg-user" : "msg-bot");
      const bubble = document.createElement("div");
      bubble.className = "bubble " + (from === "user" ? "bubble-user" : "bubble-bot");
      bubble.textContent = text;
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent = from === "user" ? "Vous" : "IA Retroworld";
      wrap.appendChild(bubble);
      wrap.appendChild(meta);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function sendMessage(text) {
      if (!text.trim()) return;

      addMessage(text, "user");
      inputEl.value = "";
      typingEl.style.display = "block";
      sendBtn.disabled = true;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            message: text,
            user_id: USER_ID,
            conversation_id: getConvId()
          })
        });

        const data = await res.json();
        if (data && data.conversation_id) setConvId(data.conversation_id);

        const answer = data.answer || data.reply || "DÃ©solÃ©, je n'ai pas compris la rÃ©ponse du serveur.";
        addMessage(answer, "bot");

      } catch (err) {
        addMessage("Erreur de connexion au serveur IA.", "bot");
        console.error(err);
      } finally {
        typingEl.style.display = "none";
        sendBtn.disabled = false;
        inputEl.focus();
      }
    }

    formEl.addEventListener("submit", (e) => {
      e.preventDefault();
      sendMessage(inputEl.value);
    });

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage(inputEl.value);
      }
    });

    addMessage("Bonjour, je suis lâ€™assistant Retroworld. Dites-moi ce que vous cherchez (tarifs, rÃ©servation, goÃ»ter/anniversaire, fidÃ©litÃ©â€¦) ðŸ˜Š");
  </script>
</body>
</html>
