<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Runningman + Retroworld</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e9eef5; margin:0; }
    .app { max-width: 640px; margin: 0 auto; padding: 16px; }
    .card { background:#121824; border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,0.3); }
    .title { font-weight:700; font-size:18px; margin-bottom:12px; }
    .messages { height: 420px; overflow:auto; padding:8px; border-radius:12px; background:#0d131f; border:1px solid #1b2638; }
    .bubble { padding:10px 12px; border-radius:12px; margin:8px 0; max-width: 80%; line-height:1.35; white-space:pre-wrap }
    .user { background:#1e293b; margin-left:auto; }
    .bot  { background:#111827; border:1px solid #22324a; }
    .row { display:flex; gap:8px; margin-top:12px; }
    input[type="text"] { flex:1; padding:12px; border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e9eef5; outline:none; }
    button { padding:12px 16px; border:0; border-radius:12px; background:#3b82f6; color:white; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { color:#9fb1ca; font-size:12px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="title">üí¨ Assistant Runningman & Retroworld</div>
      <div id="messages" class="messages"></div>
      <div class="row">
        <input id="input" type="text" placeholder="Posez votre question (Game Zone, VR, Escape VR, quiz, anniversaire‚Ä¶)">
        <button id="send">Envoyer</button>
      </div>
      <div class="hint">Ex: ‚ÄúJe veux organiser un anniversaire samedi pour 10 enfants. Quelles options ?‚Äù</div>
    </div>
  </div>

  <script>
    const API_BASE = location.origin; // si widget servi par le m√™me serveur que l'API
    const $messages = document.getElementById('messages');
    const $input = document.getElementById('input');
    const $send = document.getElementById('send');

    function addBubble(text, from='bot') {
      const b = document.createElement('div');
      b.className = 'bubble ' + (from === 'user' ? 'user' : 'bot');
      b.textContent = text;
      $messages.appendChild(b);
      $messages.scrollTop = $messages.scrollHeight;
    }

    function genId(prefix){
      return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function getParam(name){
      try {
        return new URL(location.href).searchParams.get(name) || "";
      } catch(e){
        return "";
      }
    }

    function setParam(name, value){
      try{
        const url = new URL(location.href);
        if(value) url.searchParams.set(name, value);
        else url.searchParams.delete(name);
        history.replaceState({}, "", url.toString()); // ‚úÖ persiste m√™me si storage KO
      }catch(e){}
    }

    // -------------------------------
    // BETON IDs (URL -> RAM -> storage)
    // -------------------------------
    let MEM_UID = "";
    let MEM_CID = "";

    function getOrCreateUserId(){
      // 1) URL
      const fromUrl = getParam("rw_uid");
      if(fromUrl){ MEM_UID = fromUrl; return fromUrl; }

      // 2) RAM
      if(MEM_UID) return MEM_UID;

      // 3) localStorage
      try {
        const v = localStorage.getItem("rw_user_id") || "";
        if(v){ MEM_UID = v; return v; }
      } catch(e){}

      // 4) create
      const v = genId("u");
      MEM_UID = v;
      setParam("rw_uid", v);
      try { localStorage.setItem("rw_user_id", v); } catch(e){}
      return v;
    }

    function getConvId(){
      // 1) URL
      const fromUrl = getParam("rw_cid");
      if(fromUrl){ MEM_CID = fromUrl; return fromUrl; }

      // 2) RAM
      if(MEM_CID) return MEM_CID;

      // 3) localStorage
      try {
        const v = localStorage.getItem("rw_conversation_id") || "";
        if(v){ MEM_CID = v; return v; }
      } catch(e){}

      return "";
    }

    function setConvId(v){
      if(!v) return;
      MEM_CID = v;
      setParam("rw_cid", v); // ‚úÖ cl√© b√©ton
      try { localStorage.setItem("rw_conversation_id", v); } catch(e){}
    }

    const USER_ID = getOrCreateUserId();

    async function sendMessage() {
      const msg = $input.value.trim();
      if (!msg) return;

      addBubble(msg, 'user');
      $input.value = '';
      $input.focus();
      $send.disabled = true;

      try {
        const res = await fetch(API_BASE + '/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msg,
            user_id: USER_ID,
            conversation_id: getConvId()
          })
        });

        const data = await res.json();
        if (data && data.conversation_id) setConvId(data.conversation_id);

        const answer = data.answer || data.reply || "D√©sol√©, je n'ai pas compris.";
        addBubble(answer, 'bot');

      } catch (e) {
        addBubble("Erreur de connexion. R√©essayez.", 'bot');
      } finally {
        $send.disabled = false;
      }
    }

    $send.addEventListener('click', sendMessage);
    $input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    addBubble("Bienvenue chez Runningman et Retroworld üëã\n\nPour vous orienter :\n- Game Zone + salle VR : Runningman\n- Le reste (Escape Game VR, quiz, salle enfant, anniversaires, fid√©lit√©) : Retroworld\n\nComment puis-je vous aider ?");
  </script>
</body>
</html>
